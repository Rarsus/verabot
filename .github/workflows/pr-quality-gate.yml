name: PR Quality Gate

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    name: Validate Pull Request
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run Tests
        run: npm test -- --coverage

      - name: Security Audit
        run: npm audit --production
        continue-on-error: true

      - name: Check commit messages
        run: |
          # Validate commit message format (conventional commits)
          git log --format=%B ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E "^(feat|fix|docs|style|refactor|test|chore|ci|perf|revert)(\(.+\))?!?:" || echo "Note: Not all commits follow conventional commits format"

      - name: Generate summary
        if: always()
        run: |
          echo "## PR Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "✅ Linting: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security: Passed" >> $GITHUB_STEP_SUMMARY

  comment-on-pr:
    runs-on: ubuntu-latest
    name: Add PR Comment
    if: github.event.action == 'opened'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Quality Gate Checks\n\nThis PR will run through the following checks:\n\n- ✅ Linting (ESLint)\n- ✅ Unit Tests (100% coverage required)\n- ✅ Security Audit (npm audit)\n- ✅ Code Coverage Analysis\n\nThank you for contributing!'
            })
